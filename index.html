<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Typewriter - Precision Overprint</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            background-image: radial-gradient(circle, rgba(255,245,200,0.15) 0%, rgba(0,0,0,0.9) 80%);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; overflow-y: auto; padding: 40px 0;
            font-family: 'Special Elite', serif;
        }

        /* Container for all pages */
        #desk {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding-bottom: 100px;
        }

        /* Short Bond Paper (8.5 x 11) Dimensions */
        .paper {
            width: 612px; 
            height: 792px;
            background-color: #f4ecd8;
            background-image: url("image_7308c0.jpg"); 
            background-size: 100% 100%;
            background-position: center;
            padding: 110px 70px 70px 85px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            font-size: 20px;
            line-height: 1.8; 
            color: rgba(40, 40, 40, 0.9);
            outline: none; 
            white-space: pre-wrap; 
            position: relative;
            border: none; 
            overflow: hidden;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .strike-container {
            display: inline-flex; position: relative;
            vertical-align: bottom; width: 1ch;
            pointer-events: none; user-select: none;
        }

        .base-char { opacity: 0.5; }
        .correction-char {
            position: absolute; left: 0; top: 0;
            color: #000 !important; font-weight: 900;
            text-shadow: 0.5px 0px 0px #000;
        }

        #overlay {
            position: fixed; inset: 0; background: #222; color: #f4ecd8;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 100;
        }

        .controls {
            position: fixed; bottom: 20px;
            display: flex; gap: 15px; z-index: 10;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 50px;
        }

        button {
            padding: 10px 20px; font-family: 'Special Elite'; font-size: 1rem;
            cursor: pointer; border: 2px solid #f4ecd8; background: transparent; color: #f4ecd8;
            transition: 0.3s; border-radius: 5px;
        }
        button:hover { background: #f4ecd8; color: #1a1a1a; }
    </style>
</head>
<body>

<div id="overlay">
    <h1>MECHANICAL TYPE</h1>
    <p>Precision Bond Paper size enabled.</p>
    <button id="start">LOAD PAPER</button>
</div>

<div id="desk">
    <div id="page-1" class="paper" contenteditable="true" spellcheck="false"></div>
</div>

<div class="controls">
    <button id="addPageBtn">NEW PAGE</button>
    <button id="saveBtn">SAVE CURRENT PAGE</button>
</div>

<script>
    let pageCount = 1;
    let activePaper = document.getElementById('page-1');
    const sounds = { clack: new Audio('clack.mp3'), ding: new Audio('ding.mp3') };

    function playSound(type) {
        try {
            const s = sounds[type].cloneNode();
            s.currentTime = (type === 'clack') ? 2.2 : 0.2;
            s.volume = 0.9;
            s.play();
            setTimeout(() => { s.pause(); s.remove(); }, 700);
        } catch(e) {}
    }

    // Start App
    document.getElementById('start').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        activePaper.focus();
    });

    // Page Break Logic (Add New Page)
    document.getElementById('addPageBtn').addEventListener('click', () => {
        playSound('ding');
        pageCount++;
        const newPage = document.createElement('div');
        newPage.id = `page-${pageCount}`;
        newPage.className = 'paper';
        newPage.contentEditable = "true";
        newPage.spellcheck = false;
        
        document.getElementById('desk').appendChild(newPage);
        activePaper = newPage;
        newPage.focus();
        newPage.scrollIntoView({ behavior: 'smooth' });
        attachTypewriterLogic(newPage);
    });

    function attachTypewriterLogic(element) {
        element.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { playSound('ding'); return; }

            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            let range = sel.getRangeAt(0);

            if (e.key === 'Backspace') {
                e.preventDefault();
                playSound('clack');
                sel.modify("move", "backward", "character");
                return;
            }

            if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                const container = range.startContainer;
                const offset = range.startOffset;

                if (container.nodeType === Node.TEXT_NODE && offset < container.length) {
                    e.preventDefault();
                    playSound('clack');
                    const charToCover = container.textContent[offset];
                    const wrapper = document.createElement('span');
                    wrapper.className = 'strike-container';
                    wrapper.contentEditable = "false"; 
                    wrapper.innerHTML = `<span class="base-char">${charToCover}</span><span class="correction-char">${e.key}</span>`;

                    const deleteRange = document.createRange();
                    deleteRange.setStart(container, offset);
                    deleteRange.setEnd(container, offset + 1);
                    deleteRange.deleteContents();
                    
                    range.insertNode(wrapper);
                    range.setStartAfter(wrapper);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    playSound('clack');
                }
            }
        });

        // Set active paper on focus
        element.addEventListener('focus', () => {
            activePaper = element;
        });
    }

    // Initialize first page
    attachTypewriterLogic(activePaper);

    // Save logic
    document.getElementById('saveBtn').addEventListener('click', () => {
        const btn = document.getElementById('saveBtn');
        btn.innerText = "CAPTURING...";

        html2canvas(activePaper, {
            scale: 2,
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `typewriter-page-${activePaper.id}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            btn.innerText = "SAVE CURRENT PAGE";
        }).catch(err => {
            console.error(err);
            btn.innerText = "SAVE ERROR";
        });
    });
</script>
</body>
</html>
